<div class="projects-page">

  <!-- Header -->
  <div class="page-header">
    <h1 class="page-title">Mes Projets</h1>

    <div class="search-filter">
      <div class="search-box">
        <span class="search-icon">üîç</span>
        <input
          type="text"
          class="search-input"
          placeholder="Rechercher un projet..."
          [(ngModel)]="search"
        >
      </div>

      <!-- Filtre statut -->
      <select id="statut" [(ngModel)]="statut" class="form-control">
        <option value="ALL">Tous les projets</option>
        <option value="EN_COURS">En cours</option>
        <option value="TERMINE">Termin√©</option>
      </select>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="loading && projets.length === 0" class="loading-state">
    <p>‚è≥ Chargement des projets...</p>
  </div>

  <!-- Error -->
  <div *ngIf="error && !loading && projets.length === 0" class="error-state">
    <p>‚ö†Ô∏è {{ error }}</p>
    <button (click)="chargerProjets()">R√©essayer</button>
  </div>

  <!-- Empty -->
  <div *ngIf="!loading && !error && filtered.length === 0" class="empty-state">
    <h3>üì≠ Aucun projet trouv√©</h3>
  </div>

  <!-- Grid -->
  <div class="projects-grid" *ngIf="!loading && !error && filtered.length">

    <div class="project-card" *ngFor="let p of filtered; trackBy: trackById">

      <!-- Media -->
      <div class="project-media">
        <img
          [src]="mediaSrc(p)"
          (error)="onImgError($event)"
          class="media-img"
          [alt]="p.titre"
        >
        <!-- ‚úÖ Badge Statut -->
        <div class="statut-badge" [class.statut-termine]="p.statut === 'TERMINE'">
          {{ getStatutLabel(p.statut) }}
        </div>
      </div>

      <!-- Body -->
      <div class="project-body">

        <!-- Header with Title -->
        <div class="project-header">
          <h3 class="project-title">{{ p.titre }}</h3>
        </div>

        <!-- Description -->
        <p class="project-description">
          {{ p.description || 'Aucune description' }}
        </p>

        <!-- Meta Info -->
        <div class="project-meta">
          <div class="meta-item">
            <span class="meta-icon">üè¢</span>
            {{ p.organisationNom }}
          </div>

          <div class="meta-item">
            <span class="meta-icon">üìÖ</span>
            {{ p.dateCreation | date:'dd/MM/yyyy' }}
          </div>

          <!-- ‚úÖ Afficher le statut -->
          <div class="meta-item statut-info">
            <span class="meta-icon" [class.statut-icon-termine]="p.statut === 'TERMINE'">
              {{ p.statut === 'TERMINE' ? '‚úÖ' : '‚è≥' }}
            </span>
            <span [class.statut-text-termine]="p.statut === 'TERMINE'">
              {{ p.statut === 'TERMINE' ? 'Termin√©' : 'En cours' }}
            </span>
          </div>
        </div>

        <!-- Actions -->
        <div class="project-actions">

          <!-- Localisation -->
          <button
            class="btn-outline-primary"
            *ngIf="hasGPS(p)"
            (click)="openMap(p)"
            title="Voir sur la carte"
          >
            <i class="bi bi-geo-alt-fill"></i>
          </button>

          <!-- Modifier -->
          <button
            class="btn-outline-warning"
            (click)="modifierProjet(p)"
            [disabled]="loading"
            title="Modifier"
          >
            <i class="bi bi-pencil-fill"></i>
          </button>

          <!-- Supprimer -->
          <button
            class="btn-outline-danger"
            (click)="supprimerProjet(p.id)"
            [disabled]="loading"
            title="Supprimer"
          >
            <i class="bi bi-trash-fill"></i>
          </button>

        </div>

      </div>
    </div>
  </div>

</div>

<!-- ===================== MODAL DE MODIFICATION ===================== -->
<div class="modal-overlay" *ngIf="projetModif" (click)="fermerModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">

    <div class="modal-header">
      <h2>‚úèÔ∏è Modifier le projet</h2>
      <button class="close-btn" (click)="fermerModal()" type="button">‚úï</button>
    </div>

    <div class="modal-body">

      <!-- TITRE -->
      <div class="form-group">
        <label for="titre">Titre *</label>
        <input
          id="titre"
          type="text"
          [(ngModel)]="projetModif.titre"
          class="form-control"
          placeholder="Titre du projet"
          required
        >
      </div>

      <!-- DESCRIPTION -->
      <div class="form-group">
        <label for="description">Description</label>
        <textarea
          id="description"
          [(ngModel)]="projetModif.description"
          class="form-control"
          rows="4"
          placeholder="Description du projet"
        ></textarea>
      </div>

      <!-- ‚úÖ STATUT -->
      <div class="form-group">
        <label for="statut">Statut</label>
        <select id="statut" [(ngModel)]="projetModif.statut" class="form-control">
          <option value="EN_COURS">‚è≥ En cours</option>
          <option value="TERMINE">‚úÖ Termin√©</option>
        </select>
        <small class="form-text text-muted">
          Le statut passe automatiquement √† "Termin√©" si le montant demand√© est atteint
        </small>
      </div>

      <!-- URGENT -->
      <div class="form-group checkbox-group">
        <label>
          <input
            type="checkbox"
            [(ngModel)]="projetModif.urgent"
          >
          <span>üö® Projet urgent</span>
        </label>
      </div>

      <!-- GPS COORDINATES avec Bouton -->
      <div class="form-group">
        <label>
          <i class="bi bi-geo-alt-fill"></i> Position GPS *
        </label>

        <div class="gps-input-group">
          <div class="gps-coords-display">
            <div class="coord-item">
              <span class="coord-label">
                <i class="bi bi-arrow-up-right-circle-fill"></i> Latitude:
              </span>
              <span class="coord-value">{{ projetModif.latitude || 'Non d√©finie' }}</span>
            </div>
            <div class="coord-item">
              <span class="coord-label">
                <i class="bi bi-arrow-right-circle-fill"></i> Longitude:
              </span>
              <span class="coord-value">{{ projetModif.longitude || 'Non d√©finie' }}</span>
            </div>
          </div>

          <button
            type="button"
            class="btn-choose-location"
            (click)="ouvrirCarteSelection()"
          >
            <i class="bi bi-pin-map-fill"></i>
            <span>Choisir sur la carte</span>
          </button>
        </div>
      </div>

      <!-- IMAGE -->
      <div class="form-group">
        <label for="image">Image du projet</label>
        <input
          id="image"
          type="file"
          (change)="changerMedia($event)"
          accept="image/*,video/*"
          class="form-control"
        >
        <div class="preview" *ngIf="projetModif.mediaUrl">
          <img [src]="projetModif.mediaUrl" alt="Aper√ßu">
        </div>
      </div>

      <!-- ERREUR -->
      <div class="alert-error" *ngIf="error">
        ‚ö†Ô∏è {{ error }}
      </div>

    </div>

    <div class="modal-footer">
      <button
        class="btn-secondary"
        (click)="fermerModal()"
        [disabled]="loading"
        type="button"
      >
        Annuler
      </button>
      <button
        class="btn-primary"
        (click)="sauvegarderProjet()"
        [disabled]="loading || !projetModif.titre || !projetModif.titre.trim()"
        type="button"
      >
        <span *ngIf="loading">‚è≥ Enregistrement...</span>
        <span *ngIf="!loading">üíæ Enregistrer</span>
      </button>
    </div>

  </div>
</div>

<!-- ===================== MODAL S√âLECTION GPS ===================== -->
<div class="gps-modal-overlay" *ngIf="showMapSelector" (click)="fermerCarteSelection()">
  <div class="gps-modal-content" (click)="$event.stopPropagation()">

    <!-- Header -->
    <div class="gps-modal-header">
      <div class="gps-header-info">
        <h2>
          <i class="bi bi-pin-map-fill"></i>
          S√©lectionner la position
        </h2>
        <p class="gps-instruction">
          Cliquez sur la carte pour d√©finir la position du projet
        </p>
      </div>
      <button class="gps-close-btn" (click)="fermerCarteSelection()" type="button">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>

    <!-- Map Container -->
    <div class="gps-map-container">
      <div id="map" class="gps-map"></div>

      <!-- Position actuelle affich√©e -->
      <div class="map-position-display" *ngIf="tempLatitude && tempLongitude">
        <div class="position-card">
          <h4>
            <i class="bi bi-cursor-fill"></i>
            Position s√©lectionn√©e
          </h4>
          <div class="position-coords">
            <span><strong>Lat:</strong> {{ tempLatitude | number:'1.6-6' }}</span>
            <span><strong>Long:</strong> {{ tempLongitude | number:'1.6-6' }}</span>
          </div>
        </div>
      </div>

      <!-- Locate Me Button -->
      <button class="locate-me-btn" (click)="centrerSurMaPosition()" title="Me localiser">
        <i class="bi bi-crosshair"></i>
      </button>
    </div>

    <!-- Actions Footer -->
    <div class="gps-modal-footer">
      <button class="gps-action-btn btn-cancel" (click)="fermerCarteSelection()">
        <i class="bi bi-x-circle-fill"></i>
        <span>Annuler</span>
      </button>
      <button
        class="gps-action-btn btn-validate"
        (click)="validerPosition()"
        [disabled]="!tempLatitude || !tempLongitude"
      >
        <i class="bi bi-check-circle-fill"></i>
        <span>Valider la position</span>
      </button>
    </div>

  </div>
</div>

<!-- ===================== MODAL VISUALISATION GPS ===================== -->
<div class="gps-modal-overlay" *ngIf="projetGPS" (click)="fermerMapModal()">
  <div class="gps-modal-content" (click)="$event.stopPropagation()">

    <!-- Header -->
    <div class="gps-modal-header">
      <div class="gps-header-info">
        <h2>
          <i class="bi bi-geo-alt-fill"></i>
          {{ projetGPS.titre }}
        </h2>
        <p class="gps-coordinates">
          <span class="coord-label">
            <i class="bi bi-arrow-up-right-circle-fill"></i> Lat:
          </span>
          {{ projetGPS.latitude | number:'1.6-6' }}
          <span class="coord-separator">‚Ä¢</span>
          <span class="coord-label">
            <i class="bi bi-arrow-right-circle-fill"></i> Long:
          </span>
          {{ projetGPS.longitude | number:'1.6-6' }}
        </p>
      </div>
      <button class="gps-close-btn" (click)="fermerMapModal()" type="button">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>

    <!-- Map Container -->
    <div class="gps-map-container">
      <div id="mapView" class="gps-map"></div>

      <!-- Map Overlay Info -->
      <div class="map-overlay-card">
        <div class="overlay-card-header">
          <span class="overlay-icon">
            <i class="bi bi-building"></i>
          </span>
          <h4>{{ projetGPS.organisationNom }}</h4>
        </div>
        <div class="overlay-card-body">
          <p *ngIf="projetGPS.description">
            <i class="bi bi-card-text"></i>
            {{ projetGPS.description }}
          </p>
          <div class="overlay-meta">
            <div class="meta-badge">
              <i class="bi bi-calendar3"></i>
              {{ projetGPS.dateCreation | date:'dd/MM/yyyy' }}
            </div>
            <!-- ‚úÖ Afficher statut dans la carte -->
            <div class="overlay-status">
              <span class="status-dot" [class.status-termine]="projetGPS.statut === 'TERMINE'"></span>
              <span>{{ projetGPS.statut === 'TERMINE' ? '‚úÖ Termin√©' : '‚è≥ En cours' }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Actions Footer -->
    <div class="gps-modal-footer">
      <button class="gps-action-btn btn-directions" (click)="ouvrirDirections()">
        <i class="bi bi-compass-fill"></i>
        <span>Itin√©raire</span>
      </button>
      <button class="gps-action-btn btn-share" (click)="partagerLocalisation()">
        <i class="bi bi-share-fill"></i>
        <span>Partager</span>
      </button>
      <button class="gps-action-btn btn-copy" (click)="copierCoordonnees()">
        <i class="bi bi-clipboard-fill"></i>
        <span>Copier</span>
      </button>
    </div>

  </div>
</div>
